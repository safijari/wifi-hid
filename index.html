<html lang="en">
    <head>
        <title>Websocket Client</title>
        <style>
            #touchpad {
                width: 300px;
                height: 300px;
                background-color: #f0f0f0;
                touch-action: none; /* Prevent default touch behavior */
            }
        </style>
    </head>
    <body>
        <p>CPU temperature: <strong>-</strong>&deg;C</p>
        <p>NeoPixel Color: <input type="color"></p>
        <div id="touchpad"></div>
        <script>
            let ws = null;

            function startWebsocket() {
                ws = new WebSocket('ws://' + location.host + '/connect-websocket');


                ws.onopen = () => console.log('WebSocket connection opened');

                ws.onclose = function() {
                    ws = null
                    setTimeout(startWebsocket, 5000)
                }
            }

            function send(data) {
                if (ws) {
                    ws.send(JSON.stringify(data));
                } else {
                    console.log(data);
                    console.log("cannot write to websocket, it's not connected");
                }
            }

            startWebsocket();

            const touchpad = document.getElementById('touchpad');

            let startX = 0;
            let startY = 0;
            let dx = 0;
            let dy = 0;
            let tapTimeout;
            let tapStartTime = 0;
            const tapThreshold = 75;
            const sampleInterval = 25;
            let numFingies = 0;

            // Event listener for touch start
            touchpad.addEventListener('touchstart', function(e) {
                numFingies = e.touches.length;
                tapStartTime = new Date().getTime()
                send({"type": "spam", "value": ""+numFingies});
                e.preventDefault(); // Prevent default touch behavior

                const touch = e.touches[0]; // Get the first touch point
                startX = touch.clientX; // Store initial touch X position
                startY = touch.clientY; // Store initial touch Y position

                // Reset dx and dy for each new touchstart event
                dx = 0;
                dy = 0;

            });

            // Event listener for touch move
            touchpad.addEventListener('touchmove', function(e) {
                e.preventDefault(); // Prevent default touch behavior

                const touch = e.touches[0]; // Get the first touch point
                const deltaX = touch.clientX - startX; // Calculate delta X
                const deltaY = touch.clientY - startY; // Calculate delta Y

                dx += deltaX;
                dy += deltaY;

                // Update startX and startY for the next touch move event
                startX = touch.clientX;
                startY = touch.clientY;

                // Cancel the single tap detection timeout
                clearTimeout(tapTimeout);
            });

            // Event listener for touch end
            touchpad.addEventListener('touchend', function(e) {
                e.preventDefault(); // Prevent default touch behavior

                // Detect double tap
                const now = new Date().getTime();
                if (now - tapStartTime < tapThreshold) {
                    if (numFingies >= 2) {
                        // Handle two finger tap logic here
                        console.log('Two finger tap detected');
                        send({"type": "rightclick"});
                        numFingies = 0;
                    } else if (numFingies == 1) {
                        send({ "type": "click" });
                        numFingies = 0;
                    }
                }
            });

            // Event listener for two finger swipe (vertical)
            let lastTouchY = 0;
            touchpad.addEventListener('touchmove', function(e) {
                if (numFingies >= 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];

                    const currentTouchY = Math.abs(touch1.clientY - touch2.clientY);
                    const deltaY = currentTouchY - lastTouchY;

                    if (Math.abs(deltaY) > 10) { // Threshold for swipe detection
                        if (deltaY > 0) {
                            console.log('Two finger swipe down detected (scroll down)');
                        } else {
                            console.log('Two finger swipe up detected (scroll up)');
                        }
                        lastTouchY = currentTouchY;
                    }
                }
            });


            setInterval(function() {
            if (dx != 0 && dy != 0) {
                send({"type": "mousemove", "dx": dx, "dy": dy});
                dx = 0;
                dy = 0;
            }
            }, sampleInterval);


        </script>
    </body>
</html>
